"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var fs=require("fs"),path=require("path"),ts=require("typescript"),TAB=" ",DOUBLE_BYTE_REGEX=/[^\x00-\xff]/g;function removeFileComment(e,t){var r=ts.createPrinter({removeComments:!0}),i=ts.createSourceFile("",e,ts.ScriptTarget.ES2015,!0,t.endsWith(".tsx")?ts.ScriptKind.TSX:ts.ScriptKind.TS);return r.printFile(i)}var BasePath=path.resolve(__dirname);function upperCase(e,t){return 0===t?e:e.charAt(0).toUpperCase()+e.slice(1)}function genKey(e){var t=path.parse(e),r=t.name,i=t.dir,n=(i=i.replace(/.*:/,"")).split(/[\/\\\\]/),a=n.indexOf("src");return n.splice(0,a+1),n.push(r),n.map(function(e,t){return upperCase(e,t).replace(/-/g,"")}).join("")}function saveFile(e,t,r){var i=ts.createPrinter().printFile(e);r&&(i=r.join("\n")+"\n"+i),fs.writeFileSync(t,i)}function measureText(e,t){return t?"":e.replace(/;/g,"").replace(/[\r\n]/g,"").replace(/\$/g,"").replace(/[`'"]/g,"")}function is(e,t){var r=Object.prototype.toString.call(e);return r.substring(8,r.length-1).toLowerCase()===t}function getVariableFromTmeplateString(e){if(!e)return[];for(var t=/\$\{(.+?)\}/g,r=[];;){var i=t.exec(e);if(!i)break;r.push(i[1])}return r}function transformChinese(u,f){var e=global.intlConfig,m=e.extractOnly,t=e.prefix,d=e.templateString,h=[],r=ts.createSourceFile("",u,ts.ScriptTarget.ES2015,!0,ts.ScriptKind.TSX),v=genKey(f),g=1,i=ts.transform(r,[function(p){return function(e){return ts.visitNode(e,function e(t){var r=""+v+g;switch(t.kind){case ts.SyntaxKind.StringLiteral:if(!(a=t.text).match(DOUBLE_BYTE_REGEX)||(h.push({key:r,value:a,comment:"/** "+a+" **/"}),g+=1,m))break;var i=t.parent.kind===ts.SyntaxKind.JsxAttribute?"{i18n."+r+"}":"i18n."+r;return ts.createIdentifier(i);case ts.SyntaxKind.JsxText:var n=removeFileComment(a=t.getText(),f);if(n.match(DOUBLE_BYTE_REGEX)&&(h.push({key:r,value:n,comment:"/** "+n+" **/"}),g+=1,!m))return ts.createJsxText("{ i18n."+r+" }");break;case ts.SyntaxKind.TemplateExpression:var a,s=t.pos,o=t.end;if((a=u.slice(s,o)).match(DOUBLE_BYTE_REGEX)){if(d&&d.funcName){h.push({key:r,value:a.replace(/\$(?=\{)/g,""),comment:"/** "+a+" **/"}),g+=1;var c=getVariableFromTmeplateString(a),l=ts.createObjectLiteral(c.map(function(e){return ts.createPropertyAssignment(e,ts.createIdentifier(e))}));return ts.createCall(ts.createIdentifier(d.funcName),void 0,[ts.createIdentifier("i18n."+r),l])}console.warn("模板字符串："+f+" "+a+" 无法处理")}}return ts.visitEachChild(t,e,p)})}}]).transformed[0];return m||saveFile(i,f,t),h}var mkdirp=require("mkdirp"),whiteListFileType=[".ts",".tsx",".js",".jsx"];function writeFile(e,t){var r=global.intlConfig,i=r.template,n=r.mode;if(0!==e.length){var a=e.map(function(e){return e.comment+"\n"+TAB+e.key+": '"+measureText(e.value,i)+"',"}).join("\n");a="sample"===n?"\n"+a:"export default {\n"+a+"\n}";var s="sample"===n?fs.appendFileSync:fs.writeFileSync;if("depth"===n){var o=path.dirname(t);fs.existsSync(o)||mkdirp.sync(o)}try{s(t,a)}catch(e){console.log(e)}}}function writeFileDepth(e,t){var r=global.intlConfig,i=r.outputPath,n=r.rootPath,a=t.replace(n,"").substring(1);writeFile(e,path.resolve(i,a))}function init(e){var t=e.outputPath,r=e.whiteList,i=e.mode,n=e.template;if(console.time("总计用时："),is(r,"array")&&0<r.length&&(whiteListFileType=r),delete e.whiteList,n&&(e.extractOnly=!0),global.intlConfig=e,"sample"===i)try{fs.writeFileSync(t,"export default {")}catch(e){console.log("新建多语言文件"+t+"失败！")}else fs.mkdir(t,function(e){e&&"EEXIST"!==e.code&&console.log("创建多语言目录"+t+"失败！")})}function traverseDir(t,r){if(fs.statSync(t).isFile()){if(!whiteListFileType.includes(path.extname(t)))return;var e=global.intlConfig.mode,i=transformChinese(fs.readFileSync(t).toString(),t);"sample"===e?writeFile(i,r):writeFileDepth(i,t)}else{fs.readdirSync(t).forEach(function(e){traverseDir(path.resolve(t,e),r)})}}function traverse(e){init(e),traverseDir(e.rootPath,e.outputPath),"sample"===e.mode&&fs.appendFileSync(e.outputPath,"\n}"),console.timeEnd("总计用时：")}exports.traverse=traverse;
