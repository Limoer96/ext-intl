"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var fs=require("fs"),path=require("path"),ts=require("typescript");function removeFileComment(e,t){var r=ts.createPrinter({removeComments:!0}),n=ts.createSourceFile("",e,ts.ScriptTarget.ES2015,!0,t.endsWith(".tsx")?ts.ScriptKind.TSX:ts.ScriptKind.TS);return r.printFile(n)}var BasePath=path.resolve(__dirname);function upperCase(e,t){return 0===t?e:e.charAt(0).toUpperCase()+e.slice(1)}function genKey(e){var t=path.parse(e),r=t.name,n=t.dir,i=(n=n.replace(/.*:/,"")).split(/[\/\\\\]/),s=i.indexOf("src");return i.splice(0,s+1),i.push(r),i.map(function(e,t){return upperCase(e,t)}).join("")}function printToFile(e,t,r,n){if(0!==t.length){t.sort(function(e,t){return t.pos-e.pos});for(var i=0,s=t;i<s.length;i++){var a=s[i],o=a.pos,l=a.end,c=a.text;e=e.substring(0,o)+c+e.substring(l)}n&&(e=n+e),fs.writeFileSync(r,e)}}function measureText(e,t){return t?"":e.replace(/;/g,"").replace(/[\r\n]/g,"").replace(/\$/g,"").replace(/[`'"]/g,"")}function is(e,t){var r=Object.prototype.toString.call(e);return r.substring(8,r.length-1).toLowerCase()===t}var DOUBLE_BYTE_REGEX=/[^\x00-\xff]/g;function findTextInTs(l,c){var e=global.intlConfig,p=e.extractOnly,t=e.prefix,u=[],f=[],r=l,n=ts.createSourceFile("",l,ts.ScriptTarget.ES2015,!0,ts.ScriptKind.TSX),h=genKey(c),d=1;return ts.forEachChild(n,function e(t){switch(t.kind){case ts.SyntaxKind.StringLiteral:var r=t,n=r.text,i=r.pos,s=r.end;if(n.match(DOUBLE_BYTE_REGEX)){if(!p){var a=t.parent.kind;f.push({pos:i,end:s,text:a===ts.SyntaxKind.JsxAttribute?"{I18N."+h+d+"}":"I18N."+h+d})}u.push({key:""+h+d,value:n,comment:"/** "+n+" **/"}),d+=1}break;case ts.SyntaxKind.JsxElement:t.children.forEach(function(e){if(e.kind===ts.SyntaxKind.JsxText){var t=e.getText(),r=e.pos,n=e.end,i=removeFileComment(t,c);i.match(DOUBLE_BYTE_REGEX)&&(p||f.push({pos:r,end:n,text:"{ I18N."+h+d+" }"}),u.push({key:""+h+d,value:i,comment:"/** "+i+" **/"}),d+=1)}});break;case ts.SyntaxKind.TemplateExpression:i=t.pos,s=t.end;var o=l.slice(i,s);o.match(DOUBLE_BYTE_REGEX)&&(console.warn("模板字符串："+c+" "+o+" 无法处理"),u.push({key:""+h+d++,value:o,comment:"/** "+o+" **/"}))}ts.forEachChild(t,e)}),printToFile(r,f,c,t),u}var TAB=" ",whiteListFileType=[".ts",".tsx",".js",".jsx"];function writeFile(e,t){var r=global.intlConfig,n=r.template,i=r.mode;if(0!==e.length){var s=e.map(function(e){return e.comment+"\n"+TAB+e.key+": '"+measureText(e.value,n)+"',"}).join("\n");s="sample"===i?"\n"+s:"export default {\n"+s+"\n}";var a="sample"===i?fs.appendFileSync:fs.writeFileSync;try{a(t,s)}catch(e){console.log(e)}}}function writeFileDepth(e,t){var r=global.intlConfig,n=r.outputPath,i=r.rootPath,s=t.replace(i,"").substring(1);writeFile(e,path.resolve(n,s))}function init(e){var t=e.outputPath,r=e.whiteList,n=e.mode;if(console.time("总计用时："),is(r,"array")&&0<r.length&&(whiteListFileType=r),delete e.whiteList,global.intlConfig=e,"sample"===n)try{fs.writeFileSync(t,"export default {")}catch(e){console.log("新建多语言文件"+t+"失败！")}else fs.mkdir(t,function(e){e&&"EEXIST"!==e.code&&console.log("创建多语言目录"+t+"失败！")})}function traverseDir(t,r){if(fs.statSync(t).isFile()){if(!whiteListFileType.includes(path.extname(t)))return;var e=global.intlConfig.mode,n=findTextInTs(fs.readFileSync(t).toString(),t);"sample"===e?writeFile(n,r):writeFileDepth(n,t)}else{fs.readdirSync(t).forEach(function(e){traverseDir(path.resolve(t,e),r)})}}function traverse(e){init(e),traverseDir(e.rootPath,e.outputPath),"sample"===e.mode&&fs.appendFileSync(e.outputPath,"\n}"),console.timeEnd("总计用时：")}exports.traverse=traverse;
